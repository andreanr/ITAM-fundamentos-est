---
title: "fundamentos"
output: html_document
---

```{r options, echo = FALSE}
knitr::opts_chunk$set(
    comment = "",
    collapse = TRUE,
    message = FALSE,
    error=TRUE, 
    fig.align = "center",
    warning=FALSE
)
```

$y_{ij}$ ~ $Ga(y|\alpha, \beta)$
i - individuo i =1, ..., 70
j - mediciones para cada individuo i
y - concentración de glucosa en la sangre

$\alpha, \beta$ desconocidas



Los datos diabetes-data.csv contienen la información de medición de glucosa en la sangre de 70 pacientes con diabetes observados en diferentes momentos del tiempo (horas, días, semanas, meses).

El contenido y formato de los datos es el siguiente:

a) Fecha (date) en formato MM-DD-YYYY
b) Hora (time) en formato XX:YY
c) Código (code)
d) Nivel de glucosa (value)
e) Indicadora de paciente (individual)

Los datos de concentración en la sangre se obtienen de dos fuentes:

Mediciones electrónicas automáticas
Registros escritos en papel.
Las mediciones eletrónicas automáticas se obtienen con etiquetas de tiempo específicas, mientras que las mediciones obtenidas de los registros *escritos* corresponden a *horarios ficticios* con la siguiente relación: Desayuno (08:00), comida (12:00), cena (18:00), y hora de dormir (22:00).

El campo code corresponde al tipo de insulina administrada al paciente.

Nota: La información de la adminitración de insulina, en este momento, es irrelevante.

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(readr)
library(stringr)
library(lubridate)
library(ggplot2)

theme_set(theme_bw())
# Lectura de datos
diabetes <- read_csv("datos/data_diabetes.csv", col_types = list(
  X1 = col_integer(),
  date = col_character(),
  time = col_time(format = ""),
  code = col_integer(),
  value = col_double(),
  individual = col_integer())) %>% 
  select(-X1)

# Catalogo de codigos
catalogo_code <- read_csv("docs/catalogo_code.csv")

```


```{r, warning=FALSE, message=FALSE}
# Base de datos 
bd_diabetes <- diabetes %>% 
  left_join(catalogo_code)
  
summary(bd_diabetes)
glimpse(bd_diabetes)
```

1. ¿Existe discrepancia (en media o distribucional) entre las mediciones reportadas de registros escritos en papel y las que son reportadas electrónicamene?

```{r, warning=FALSE, message=FALSE}
bd_mediciones <- bd_diabetes %>% 
  mutate(atributo = str_replace_all(atributo, " ", "_")) %>% 
  filter(str_detect(atributo, "medición"))

# separamos escritos vs. aparato
escritos_hrs <- c(8, 12, 18, 22)
bd_mediciones <- bd_mediciones %>% 
  mutate(tipo=ifelse((hour(time) %in% escritos_hrs) &
          (minute(time) == 0), 'papel', 'electrónico'))

# Plot 
mean_papel <- subset(bd_mediciones, tipo == 'papel') %>% 
  select(value) %>% flatten_dbl() %>% mean(na.rm = TRUE)
mean_electronicos <- subset(bd_mediciones, tipo == 'electrónico') %>% 
  select(value) %>% flatten_dbl() %>% mean(na.rm = TRUE)

ggplot(bd_mediciones, aes(x=value, fill=tipo)) +
  geom_histogram(alpha=0.2, position="identity") +
  scale_fill_manual(values=c("darkcyan", "magenta")) +
  geom_vline(aes(xintercept = mean_papel, color="magenta"), 
             show.legend = FALSE) + 
  geom_vline(aes(xintercept = mean_electronicos, color="darkcyan"),
             show.legend = FALSE ) +
  ggtitle("histogramas mediciones de glucosa")
```


2. ¿ Existe discrepancia entre las mediciones de glucosa de los pacientes entre las cuatro horas del día
donde se miden?


```{r, warning=FALSE, message=FALSE}
mediciones_4 <- bd_diabetes %>%
  filter(str_detect(atributo, "medición")) %>% 
  filter(hour(time) %in% c(8, 12, 18, 22), minute(time) == 0, second(time) == 0)

ggplot(mediciones_4) +
  geom_boxplot(aes(x = atributo, y = value, color = atributo)) + 
  facet_grid(~as.factor(hour(time))) +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.x=element_blank()) +
  ggtitle("Medición de glucosa en sangre")


ggplot(mediciones_4) +
  geom_boxplot(aes(x = "1", y = value, color = as.factor(hour(time)))) + 
  facet_grid(~as.factor(hour(time))) +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.x=element_blank()) +
  ggtitle("Medición de glucosa en sangre")
```

3. ¿ Existe discrepancia de las mediciones de glucosa entre pacientes?

```{r, warning=FALSE, message=FALSE}
bd_mediciones %>% 
  group_by(individual) %>% 
  summarise(medicion_glucosa = mean(value, na.rm = TRUE)) %>% 
  ggplot(aes(x = individual, y = medicion_glucosa)) +
  geom_point()+
  geom_line()
```

4. ¿ Existe discrepancia entre las mediciones de glucosa asociadas con la administración de insulina con respecto a las demás?

```{r, warning=FALSE, message=FALSE}
base_dosis_med <- bd_diabetes %>% 
  filter(str_detect(atributo, c("medición", "dosis")))

base_dosis_med <-base_dosis_med %>% 
  mutate(ID = group_indices_(base_dosis_med, 
                           .dots=c("individual", "date", "time")))

base_dosis_med <- base_dosis_med  %>% 
  mutate(tipo = ifelse(startsWith(atributo,"medición"),
                       "medición", "dosis")) %>% 
  select(ID, individual, date, time, value, tipo) %>% 
  distinct(individual, date, time, tipo, .keep_all = TRUE) %>% 
  spread(tipo, value) %>% 
  subset( !is.na(medición)) %>% 
  mutate(dosis=ifelse(!is.na(dosis), TRUE, FALSE))

# Plot
ggplot(base_dosis_med, aes(x = dosis, y = medición)) +
  geom_boxplot(fill = "#4271AE", colour = "#1F3552",
               alpha = 0.7) +
  stat_summary(fun.y=mean, colour="darkred", geom="point", 
               shape=18, size=3, show.legend = FALSE) + 
  scale_x_discrete(name = "Dosis incluida") +
  ggtitle("Boxplot mediciones de glucosa") 
```

5. ¿Existe una discrepancia clara entre los pacientes que reportan sus niveles de glocosa depués de haber ingerido más alimentos de lo usual?

```{r}
base_ingesta <- bd_diabetes %>% 
  mutate(hora = hour(time)) %>% 
  filter(atributo %in% c(atributo[str_detect(atributo, "medición")], atributo[str_detect(atributo, "ingestión de comida mayor")]),
         !is.na(atributo)) %>% 
  mutate(tipo = ifelse(str_detect(atributo,"medición"), "medicion", "ingesta")) %>% 
  group_by(date, individual, tipo) %>% 
  summarise(media_glucosa = mean(value)) %>% 
  spread(tipo, media_glucosa, fill = 1) %>% 
  ungroup() 

ggplot(base_ingesta, aes(x = as.factor(ingesta), y = medicion, color = as.factor(ingesta))) +
  geom_boxplot(color = c("#42f4c5","#41cdf4")) +
  stat_summary(fun.y=mean, colour="darkred", geom="point", 
               shape=18, size=3) + 
  scale_color_manual(name = "Ingesta", values = c("Sí", "No")) +
  labs(title = "Boxplot mediciones de glucosa", x = "Ingesta mayor a lo usal",
       y = "nivel de glucosa") 
  
```

