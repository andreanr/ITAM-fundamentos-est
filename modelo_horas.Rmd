---
title: "modelo_4horas"
author: "Elizabeth Solis Diaz"
date: "12/18/2017"
output: html_document
---

¿ Existe discrepancia entre las mediciones de glucosa de los pacientes entre las cuatro horas del día
donde se miden?



```{r}
library(tidyverse)
library(readr)
library(stringr)
library(lubridate)
library(ggplot2)

theme_set(theme_bw())
# Lectura de datos
diabetes <- read_csv("datos/data_diabetes.csv", col_types = list(
  X1 = col_integer(),
  date = col_character(),
  time = col_time(format = ""),
  code = col_integer(),
  value = col_double(),
  individual = col_integer())) %>% 
  select(-X1)

# Catalogo de codigos
catalogo_code <- read_csv("docs/catalogo_code.csv")

```

```{r}
mediciones_4 <- bd_diabetes %>%
  filter(str_detect(atributo, "medición")) %>% 
  filter(hour(time) %in% c(8, 12, 18, 22), minute(time) == 0, second(time) == 0) %>% 
  mutate(horario_8am = ifelse((hour(time) %in% c(8) & minute(time) == 0 & second(time) == 0), 1, 0),
         horario_12pm = ifelse((hour(time) %in% c(12) & minute(time) == 0 & second(time) == 0), 1, 0),
         horario_18pm = ifelse((hour(time) %in% c(18) & minute(time) == 0 & second(time) == 0), 1, 0),
         horario_22pm = ifelse((hour(time) %in% c(22) & minute(time) == 0 & second(time) == 0), 1, 0),
         individual = as.factor(individual))


# n: num de individuos
n <- mediciones_4 %>% distinct(individual) %>% nrow()
m <- 4

data <- list("n" = n, "m" = m,
             "horario_8am" = mediciones_4$horario_8am, 
             "horario_12pm" = mediciones_4$horario_12pm, 
             "horario_18pm" = mediciones_4$horario_18pm, 
             "horario_22pm" = mediciones_4$horario_22pm,
             "indiv" = mediciones_4$individual,
             "y" = log(mediciones_4$value))

inits <- function(){list(alpha = rep(0.001,n), coef = rep(0,m), mu =0, sigma = 0.01, sigma.c = 0.01, a.1 = 0.01, b.1 = 0.01)}

parameters <- c("coef", "alpha", "yf1")

modelo_horas_jags <- '
model
{
  #Likelihood
  for (i in 1:n) {
    y[i] ~ dnorm(alpha[indiv[i]] + coef[1] * horario_8am[i] + coef[2] * horario_12pm[i]  + coef[3] * horario_18pm[i] + coef[4] * horario_22pm[i], tau.c)
  }
  
  #Priors 
  for (j in 1:n) {
    alpha[j] ~ dgamma(a.1, b.1)
  }
  
  # coeficientes
  for (k in 1:m){
    coef[k] ~ dnorm(mu, tau)
  }
  
  mu ~ dnorm(0, 0.001)
  tau <- pow(sigma, -2)
  sigma ~ dunif(0, 100)

  tau.c <- pow(sigma.c, -2)
  sigma.c ~ dunif(0, 100)

  a.1 ~ dgamma(0.001, 0.001)
  b.1 ~ dgamma(0.001, 0.001)

  for(i in 1:n) {
    yf1[i] ~ dnorm(alpha[indiv[i]] + coef[1] * horario_8am[i] + coef[2] * horario_12pm[i]  + coef[3] * horario_18pm[i] + coef[4] * horario_22pm[i], tau.c)
  }
}
'
cat(modelo_horas_jags, file = 'modelo_horas_jags.txt')
```

```{r}
library(R2jags)
ej2a <- jags(data = data, inits = inits, parameters.to.save = parameters, 
             model.file = "modelo_horas_jags.txt", 
             n.iter = 5000, n.chains = 3, n.burnin = 500, n.thin = 1)
```

